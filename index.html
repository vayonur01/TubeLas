<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube Viewer Game</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; background: #f0f2f5; margin:0; padding:0; text-align:center; }
header { background:#4f46e5; color:white; padding:20px; font-size:1.5em; font-weight:bold; }
#auth, #main { margin:20px auto; max-width:700px; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
button { background:#4f46e5; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:16px; margin:5px;}
button:hover { background:#3730a3; }
input { padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc; width:100%; margin:5px 0; }
#player { margin:20px auto; }
p { font-size:16px; }
</style>
</head>
<body>

<header>YouTube Viewer Game</header>

<div id="auth">
  <button id="loginBtn">Google ile Giriş Yap</button>
</div>

<div id="main" style="display:none;">
  <p>Puanın: <span id="points">0</span></p>

  <div id="addVideoDiv">
    <h3>Video Ekle</h3>
    <input type="text" id="videoUrl" placeholder="YouTube video URL'si">
    <input type="number" id="watchSeconds" placeholder="Kaç saniye izleyeceksin? (Yeni kullanıcı: 10)" min="10" max="60">
    <button id="addVideoBtn">Videoyu Ekle</button>
  </div>

  <div id="player"></div>
  <p>İzleme Süresi: <span id="timer">0</span> / <span id="goal">0</span> saniye</p>
  <button id="nextBtn">Sonraki Video</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getDatabase, ref, get, set, push, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBxzPtapNfFbmhRXKGlpQWK9VoN3_c35Jw",
  authDomain: "canli-144bb.firebaseapp.com",
  databaseURL: "https://canli-144bb-default-rtdb.firebaseio.com",
  projectId: "canli-144bb",
  storageBucket: "canli-144bb.appspot.com",
  messagingSenderId: "457370004106",
  appId: "1:457370004106:web:52976555bdd1ed8ae69b73",
  measurementId: "G-7J3M88CL85"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let videos = [];
let currentVideoIndex = 0;
let player;
let watchTime = 0;
let interval;
let goalTime = 10; // default yeni kullanıcı
let isFirstVideoAdded = false;

document.getElementById("loginBtn").addEventListener("click", async () => {
  const provider = new GoogleAuthProvider();
  try { await signInWithPopup(auth, provider); }
  catch(e){ alert("Giriş başarısız: " + e.message); }
});

onAuthStateChanged(auth, async user => {
  if(user){
    currentUser = user;
    document.getElementById("auth").style.display = "none";
    document.getElementById("main").style.display = "block";
    await loadPoints();
    await loadUserVideos();
  }
});

async function loadPoints(){
  const pointsRef = ref(db, "users/" + currentUser.uid + "/points");
  const snapshot = await get(pointsRef);
  if(snapshot.exists()){ document.getElementById("points").innerText = snapshot.val(); }
  else { await set(pointsRef, 0); document.getElementById("points").innerText = 0; }
}

// Videoları yükle
async function loadUserVideos(){
  const videosRef = ref(db, "videos");
  const snapshot = await get(videosRef);
  if(snapshot.exists()){
    videos = Object.values(snapshot.val());
  }
}

// Video ekleme
document.getElementById("addVideoBtn").addEventListener("click", async ()=>{
  const url = document.getElementById("videoUrl").value;
  let seconds = parseInt(document.getElementById("watchSeconds").value);
  if(!url){ alert("URL giriniz"); return; }
  const videoId = url.split("v=")[1]?.split("&")[0];
  if(!videoId){ alert("Geçerli YouTube URL girin."); return; }

  // İlk defa siteye gelen ve puanı olmayan kullanıcı -> sadece 1 video, süre 10
  const pointsSnapshot = await get(ref(db,"users/" + currentUser.uid + "/points"));
  const points = pointsSnapshot.exists() ? pointsSnapshot.val() : 0;
  if(points===0 && isFirstVideoAdded){ alert("Yeni kullanıcı yalnızca 1 video ekleyebilir."); return; }

  if(points===0){ seconds = 10; isFirstVideoAdded = true; } // yeni kullanıcı 10 saniye

  if(seconds < 10) seconds=10;
  if(seconds > 60) seconds=60;

  await push(ref(db,"videos"), {user: currentUser.uid, id: videoId, goal:seconds});
  videos.push({user: currentUser.uid, id: videoId, goal:seconds});
  goalTime = seconds;
  document.getElementById("goal").innerText = goalTime;
  loadVideo(videoId);
  document.getElementById("videoUrl").value="";
  document.getElementById("watchSeconds").value="";
});

// YouTube Player
function onYouTubeIframeAPIReady() {
  if(videos.length>0) loadVideo(videos[currentVideoIndex].id);
}

function loadVideo(videoId){
  if(player){
    player.loadVideoById(videoId);
  } else {
    player = new YT.Player('player', {
      height: '360',
      width: '640',
      videoId: videoId,
      events: {'onStateChange': onPlayerStateChange}
    });
  }
}

// İzleme süresi ve puan
function onPlayerStateChange(event){
  if(event.data === YT.PlayerState.PLAYING){
    interval = setInterval(()=>{
      watchTime++;
      document.getElementById("timer").innerText = watchTime;
      if(watchTime >= goalTime){
        clearInterval(interval);
        addPoints();
        player.stopVideo();
      }
    },1000);
  } else {
    clearInterval(interval);
  }
}

async function addPoints(){
  let pointsElem = document.getElementById("points");
  let currentPoints = parseInt(pointsElem.innerText) + goalTime;
  pointsElem.innerText = currentPoints;
  await set(ref(db,"users/" + currentUser.uid + "/points"), currentPoints);
  watchTime = 0;
  document.getElementById("timer").innerText = watchTime;
}

// Sıradaki video
document.getElementById("nextBtn").addEventListener("click", ()=>{
  if(videos.length === 0) return;
  currentVideoIndex = (currentVideoIndex + 1) % videos.length;
  goalTime = videos[currentVideoIndex].goal;
  document.getElementById("goal").innerText = goalTime;
  loadVideo(videos[currentVideoIndex].id);
  watchTime = 0;
  document.getElementById("timer").innerText = watchTime;
});
</script>

<script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
